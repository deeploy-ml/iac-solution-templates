{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[deployment().location]",
            "metadata": {
                "description": "Location of the resource"
            }
        },
        "coreResourceGroupName": {
          "type": "string",
          "defaultValue": "deeployCoreResourceGroup",
          "metadata": {
            "description": "Name of your cluster - Between 3 and 23 characters. Letters and numbers only"
          }
        },
        "storageResourceGroupName": {
          "type": "string",
          "defaultValue": "deeployStorageResourceGroup",
          "metadata": {
            "description": "Name of your storage Resource Group - Between 3 and 23 characters. Letters and numbers only"
          }
        },
        "clusterName": {
          "type": "string",
          "defaultValue": "deeploy",
          "metadata": {
            "description": "The name of the Managed Cluster resource."
          }
        },
        "dnsPrefix": {
          "type": "string",
          "defaultValue": "deeploy",
          "metadata": {
            "description": "Optional DNS prefix to use with hosted Kubernetes API server FQDN."
          }
        },
        "osDiskSizeGB": {
          "type": "int",
          "defaultValue": 0,
          "minValue": 0,
          "maxValue": 1023,
          "metadata": {
            "description": "Disk size (in GB) to provision for each of the agent pool nodes. This value ranges from 0 to 1023. Specifying 0 will apply the default disk size for that agentVMSize."
          }
        },
        "minAgentCount": {
          "type": "int",
          "defaultValue": 1,
          "minValue": 1,
          "maxValue": 50,
          "metadata": {
            "description": "The min number of nodes for the cluster."
          }
        },
        "maxAgentCount": {
          "type": "int",
          "defaultValue": 3,
          "minValue": 1,
          "maxValue": 50,
          "metadata": {
            "description": "The max number of nodes for the cluster."
          }
        },
        "desiredAgentCount": {
          "type": "int",
          "defaultValue": 2,
          "minValue": 1,
          "maxValue": 50,
          "metadata": {
            "description": "The max number of nodes for the cluster."
          }
        },
        "agentVMSize": {
          "type": "string",
          "defaultValue": "Standard_DS2_v2",
          "metadata": {
            "description": "The size of the Virtual Machine."
          }
        },
        "linuxAdminUsername": {
          "type": "string",
          "defaultValue": "deeploy",
          "metadata": {
            "description": "User name for the Linux Virtual Machines."
          }
        },
        "sshRSAPublicKey": {
          "type": "string",
          "metadata": {
            "description": "Configure all linux machines with the SSH RSA public key string. Your key should include three parts, for example 'ssh-rsa AAAAB...snip...UcyupgH azureuser@linuxvm'"
          }
        },
        "osType": {
          "type": "string",
          "defaultValue": "Linux",
          "allowedValues": [
            "Linux"
          ],
          "metadata": {
            "description": "The type of operating system."
          }
        },
        "saName": {
          "defaultValue": "deeploy",
          "type": "string",
          "metadata": {
              "description": "Name for Azure Storage Account"
            }
        },
        "dbName": {
          "defaultValue": "deeploy",
          "type": "string",
          "metadata": {
              "description": "Server Name for Azure database for PostgreSQL"
            }
        },
        "dbAdministratorLogin": {
          "type": "string",
          "defaultValue": "deeploy",
          "minLength": 1,
          "metadata": {
            "description": "Database administrator login name"
          }
        },
        "dbAdministratorLoginPassword": {
          "type": "securestring",
          "minLength": 8,
          "metadata": {
            "description": "Database administrator password (min 8 chars)"
          }
        },
        "dbTypeName": {
          "defaultValue": "B_Gen5_1",
          "type": "string",
          "metadata": {
              "description": "Azure database for PostgreSQL sku name"
            }
        },
        "dbTier": {
          "defaultValue": "Basic",
          "type": "string",
          "metadata": {
              "description": "Azure database for PostgreSQL sku name"
            }
        },
        "dbCapacity": {
          "type": "int",
          "defaultValue": 1,
          "metadata": {
            "description": "Azure database for PostgreSQL compute capacity in vCores (2,4,8,16,32)"
          }
        },
        "dbSizeMB": {
          "type": "int",
          "defaultValue": 51200,
          "metadata": {
            "description": "Azure database for PostgreSQL Sku Size "
          }
        },
        "dbFamily": {
          "type": "string",
          "defaultValue": "Gen5",
          "metadata": {
            "description": "Azure database for PostgreSQL sku family"
          }
        },
        "keyVaultName": {
          "type": "string",
          "defaultValue": "deeploy",
          "metadata": {
            "description": "Azure key vault name"
          }
        }
    },
    "variables": {
      "kubernetesVersion": "1.18.19",
      "storageAccountType": "Standard_LRS",
      "storageAccountTier": "Standard",
      "postgresqlVersion": "11",
      "backupRetentionDays": 7,
      "geoRedundantBackup": "Disabled",
      "vaultSkuFamily": "A",
      "vaultSkuName": "standard"
    },
    "resources": [
        {
          "type": "Microsoft.Resources/resourceGroups",
          "apiVersion": "2020-10-01",
          "name": "[parameters('coreResourceGroupName')]",
          "location": "[parameters('location')]",
          "properties": {}
        },
        {
          "type": "Microsoft.Resources/resourceGroups",
          "apiVersion": "2021-04-01",
          "name": "[parameters('storageResourceGroupName')]",
          "location": "[parameters('location')]",
          "properties": {}
        },
        {
          "type": "Microsoft.Resources/deployments",
          "apiVersion": "2020-10-01",
          "name": "coreDeployment",
          "resourceGroup": "[parameters('coreResourceGroupName')]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/resourceGroups/', parameters('coreResourceGroupName'))]"
          ],
          "properties": {
            "mode": "Incremental",
            "expressionEvaluationOptions": {
              "scope": "Outer"
            },
            "template": {
              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
              "contentVersion": "1.0.0.0",
              "parameters": {},
              "variables": {},
              "resources": [
                {
                  "type": "Microsoft.ContainerService/managedClusters",
                  "apiVersion": "2020-03-01",
                  "name": "[parameters('clusterName')]",
                  "location": "[parameters('location')]",
                  "properties": {
                    "kubernetesVersion": "[variables('kubernetesVersion')]",
                    "dnsPrefix": "[parameters('dnsPrefix')]",
                    "agentPoolProfiles": [
                      {
                        "name": "agentpool",
                        "osDiskSizeGB": "[parameters('osDiskSizeGB')]",
                        "enableAutoScaling": true,
                        "count": "[parameters('desiredAgentCount')]",
                        "minCount": "[parameters('minAgentCount')]",
                        "maxCount": "[parameters('maxAgentCount')]",
                        "vmSize": "[parameters('agentVMSize')]",
                        "osType": "[parameters('osType')]",
                        "storageProfile": "ManagedDisks",
                        "type": "VirtualMachineScaleSets",
                        "mode": "System"
                      }
                    ],
                    "linuxProfile": {
                      "adminUsername": "[parameters('linuxAdminUsername')]",
                      "ssh": {
                        "publicKeys": [
                          {
                            "keyData": "[parameters('sshRSAPublicKey')]"
                          }
                        ]
                      }
                    }
                  },
                  "identity": {
                      "type": "SystemAssigned"
                  }
                }
              ],
              "outputs": {}
            }
          }
        },
        {
          "type": "Microsoft.Resources/deployments",
          "apiVersion": "2020-10-01",
          "name": "storageDeployment",
          "resourceGroup": "[parameters('storageResourceGroupName')]",
          "dependsOn": [
            "[resourceId('Microsoft.Resources/resourceGroups/', parameters('storageResourceGroupName'))]"
          ],
          "properties": {
            "mode": "Incremental",
            "expressionEvaluationOptions": {
              "scope": "Outer"
            },
            "template": {
              "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
              "contentVersion": "1.0.0.0",
              "parameters": {},
              "variables": {},
              "resources": [
                {
                    "type": "Microsoft.Storage/storageAccounts",
                    "apiVersion": "2021-04-01",
                    "name": "[parameters('saName')]",
                    "location": "[parameters('location')]",
                    "sku": {
                        "name": "[variables('storageAccountType')]",
                        "tier": "[variables('storageAccountTier')]"
                    },
                    "kind": "StorageV2",
                    "properties": {
                        "minimumTlsVersion": "TLS1_2",
                        "allowBlobPublicAccess": true,
                        "allowSharedKeyAccess": true,
                        "networkAcls": {
                            "bypass": "AzureServices",
                            "defaultAction": "Allow"
                        },
                        "supportsHttpsTrafficOnly": true,
                        "encryption": {
                            "services": {
                                "file": {
                                    "keyType": "Account",
                                    "enabled": true
                                },
                                "blob": {
                                    "keyType": "Account",
                                    "enabled": true
                                }
                            },
                            "keySource": "Microsoft.Storage"
                        },
                        "accessTier": "Hot"
                    }
                },
                {
                    "type": "Microsoft.DBforPostgreSQL/servers",
                    "apiVersion": "2017-12-01",
                    "name": "[parameters('dbName')]",
                    "location": "[parameters('location')]",
                    "sku": {
                      "name": "[parameters('dbTypeName')]",
                      "tier": "[parameters('dbTier')]",
                      "capacity": "[parameters('dbCapacity')]",
                      "size": "[parameters('dbSizeMB')]",
                      "family": "[parameters('dbFamily')]"
                    },
                    "properties": {
                      "createMode": "Default",
                      "version": "[variables('postgresqlVersion')]",
                      "administratorLogin": "[parameters('dbAdministratorLogin')]",
                      "administratorLoginPassword": "[parameters('dbAdministratorLoginPassword')]",
                      "storageProfile": {
                        "storageMB": "[parameters('dbSizeMB')]",
                        "backupRetentionDays": "[variables('backupRetentionDays')]",
                        "geoRedundantBackup": "[variables('geoRedundantBackup')]"
                      }
                    }
                },
                {
                  "type": "Microsoft.KeyVault/vaults",
                  "name": "[parameters('keyVaultName')]",
                  "apiVersion": "2018-02-14",
                  "location": "[parameters('location')]",
                  "properties": {
                    "sku": {
                      "name": "[variables('vaultSkuName')]",
                      "family": "[variables('vaultSkuFamily')]"
                    },
                    "tenantId": "[subscription().tenantId]",
                    "accessPolicies": [],
                    "enabledForDeployment": false,
                    "enableRbacAuthorization": true,
                    "enabledForVolumeEncryption": false
                  }
                }
            ],
            "outputs": {}
            }
          }
        }  
      ],
      "outputs": {}
    }
  
  
  
  
  
  
  
  